#!/bin/bash

REPO_PATH="/home/aric/MileageTrackerAPI"
API_PATH="$REPO_PATH/MileageTrackerAPI"
CHECK_INTERVAL=10

cd "$REPO_PATH" || exit 1

echo "****************************************"
echo "API Engine Started"
echo "Elevated Permissions needed for API start"
echo "This script will check for new changes every 10 seconds."
echo "Starting API..."

read -s -p "Enter sudo password: " SUDOPASS
echo

git fetch origin
git pull

cd "$API_PATH" || exit 1
echo "$SUDOPASS" | sudo -S nohup dotnet run &
cd .. || exit 1

LAST_HASH=$(git rev-parse HEAD)

while true; do
    git fetch origin
    NEW_HASH=$(git rev-parse origin/master)
    if [ "$LAST_HASH" != "$NEW_HASH" ]; then
        echo "Changes detected. Pulling and restarting API..."
        git pull
        echo "$SUDOPASS" | sudo -S pkill -f "dotnet run"
        cd "$API_PATH" || exit 1
        echo "$SUDOPASS" | sudo -S nohup dotnet run &
        LAST_HASH=$(git rev-parse HEAD)
        cd .. || exit 1
        echo "API Updated and Restarted."
    fi
    sleep $CHECK_INTERVAL
    echo "No changes found."
done
